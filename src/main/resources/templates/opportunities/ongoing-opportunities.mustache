<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-table me-1"></i>
        ì§„í–‰ì¤‘ ê¸°íšŒ ëª©ë¡
    </div>
    <div class="card-body">
        <div class="button-container mb-3" style="display: flex; align-items: center; gap: 10px;">
            <button class="btn btn-primary btn-lg" id="AIButton">
                <i class="fas fa-robot"></i> AI ì œì•ˆì„œ ìƒì„±
            </button>
        </div>
        <table id="datatablesSimple" class="table table-bordered">
            <thead>
            <tr>
                <th></th>
                <th>ID</th>
                <th>ê¸°íšŒëª…</th>
                <th>ìƒíƒœ</th>
            </tr>
            </thead>
            <tbody>
            {{#pagination.contents}}
                <tr data-index="{{opportunityId}}"
                    data-employee="{{employeeId.employeeName}}"
                    data-product="{{productId.productName}}"
                    data-opportunity-inquiries="{{opportunityInquiries}}">
                    <td><input type="checkbox" class="select-row" value="{{opportunityId}}"></td>
                    <td>{{opportunityId}}</td>
                    <td>
                        <a href="/opportunities/detail/{{opportunityId}}">
                            {{opportunityName}}
                        </a>
                    </td>
                    <td>{{opportunityStatus}}</td>
                </tr>
            {{/pagination.contents}}
            </tbody>
        </table>
        <div class="pagination justify-content-center mt-3">
            {{#pagination.hasPreviousPage}}
                <button class="btn btn-outline-primary" onclick="window.location.href='/opportunities?page={{pagination.previousPage}}&size=10'">
                ì´ì „
                </button>
            {{/pagination.hasPreviousPage}}
            {{#pagination.pageNumbers}}
                <button class="btn btn-outline-secondary {{#isActive}}active{{/isActive}}" onclick="window.location.href='/opportunities?page={{page}}&size=10'">
                {{displayPage}}
                </button>
            {{/pagination.pageNumbers}}
            {{#pagination.hasNextPage}}
                <button class="btn btn-outline-primary" onclick="window.location.href='/opportunities?page={{pagination.nextPage}}&size=10'">
                ë‹¤ìŒ
                </button>
            {{/pagination.hasNextPage}}
        </div>
    </div>
</div>

<script>

    document.addEventListener('click', function(event) {
        if (event.target.closest('#AIButton')) { // AIButton í´ë¦­ ê°ì§€
            try {
                const selectedCheckboxes = document.querySelectorAll(".select-row:checked");

                // ğŸ”¹ ì²´í¬ëœ ê°œìˆ˜ í™•ì¸ (1ê°œë§Œ í—ˆìš©)
                if (selectedCheckboxes.length > 1) {
                    alert("í•˜ë‚˜ì˜ í•­ëª©ë§Œ ì„ íƒí•´ ì£¼ì„¸ìš”.");
                    return;
                }

                if (selectedCheckboxes.length === 0) {
                    throw new Error("ì œì•ˆì„œë¥¼ ìƒì„±í•  í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
                }

                const selectedRow = selectedCheckboxes[0].closest("tr"); // ì²´í¬ëœ í–‰ ê°€ì ¸ì˜¤ê¸°

                const employeeId = selectedRow.getAttribute("data-employee") || "ë¯¸ì§€ì •";
                const productId = selectedRow.getAttribute("data-product") || "ë¯¸ì§€ì •";
                const opportunityInquiries = selectedRow.getAttribute("data-opportunity-inquiries") || "ìš”êµ¬ì‚¬í•­ ì—†ìŒ";

                // ğŸ”¹ ì¶”ê°€ëœ ë¡œê·¸
                console.log("ì„ íƒëœ í–‰ì˜ ë°ì´í„°:", selectedRow.outerHTML);
                console.log("employeeId:", employeeId);
                console.log("productId:", productId);
                console.log("opportunityInquiries:", opportunityInquiries);

                const dataToSend = {
                    ë‹´ë‹¹ì: employeeId,
                    ì œí’ˆ: productId,
                    ê³ ê°ìš”êµ¬ì‚¬í•­: opportunityInquiries
                };

                console.log('ì „ì†¡í•  ë°ì´í„°:', dataToSend);

                fetch('https://saiescrm.api.jyds.synology.me/generate-excel', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToSend)
                })
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(new Blob([blob]));
                    const link = document.createElement('a');
                    link.href = url;
                    link.setAttribute('download', `proposal.xlsx`);
                    document.body.appendChild(link);
                    link.click();
                    window.URL.revokeObjectURL(url);
                    link.remove();
                    alert('ì œì•ˆì„œ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ì œì•ˆì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                });
            } catch (error) {
                console.error('Error:', error);
                alert(error.message);
            }
        }
    });
</script>
