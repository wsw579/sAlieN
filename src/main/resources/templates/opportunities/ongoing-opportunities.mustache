
<style>

.btn-custom-proposal {
background-color: #cce5ff; /* ì—°í•œ íŒŒë€ìƒ‰ */
color: #004085;
border: 1px solid #b8daff;
}

</style>


<div class="card mb-4">
    <div class="card-header">
        <i class="fas fa-table me-1"></i>
        ì§„í–‰ì¤‘ ê¸°íšŒ ëª©ë¡
    </div>
    <div class="card-body">
        <div class="button-container mb-3" style="display: flex; align-items: center; gap: 10px;">
            <!-- ì œì•ˆì„œ ìƒì„± ë²„íŠ¼ -->
            <button type="button" id="proposalExcelButton" class="btn btn-custom-proposal btn-sm">

                <i class= aria-hidden="true"></i>  ğŸ’¡AI ì œì•ˆì„œ excel íŒŒì¼ ìƒì„± ğŸ’¡
            </button>

            <!-- ì œì•ˆì„œ ìƒì„± ë²„íŠ¼ -->
            <button type="button" id="proposalButton" class="btn btn-custom-proposal btn-sm">

                <i class= aria-hidden="true"></i>ğŸ’¡AI ì œì•ˆì„œ ppt íŒŒì¼ ìƒì„± ğŸ’¡
            </button>
        </div>
        <table id="datatablesSimple" class="table table-bordered">
            <thead>
            <tr>
                <th></th>
                <th>ID</th>
                <th>ê¸°íšŒëª…</th>
                <th>ìƒíƒœ</th>
            </tr>
            </thead>
            <tbody>
            {{#pagination.contents}}
                <tr data-index="{{opportunityId}}"
                    data-employee="{{employeeId.employeeName}}"
                    data-product="{{productId.productName}}"
                    data-opportunity-inquiries="{{opportunityInquiries}}">
                    <td><input type="checkbox" class="select-row" value="{{opportunityId}}"></td>
                    <td>{{opportunityId}}</td>
                    <td>
                        <a href="/opportunities/detail/{{opportunityId}}">
                            {{opportunityName}}
                        </a>
                    </td>
                    <td>{{opportunityStatus}}</td>
                </tr>
            {{/pagination.contents}}
            </tbody>
        </table>
        <div class="pagination justify-content-center mt-3">
            {{#pagination.hasPreviousPage}}
                <button class="btn btn-outline-primary pagination-button" data-page="{{pagination.previousPage}}">
                    ì´ì „
                </button>
            {{/pagination.hasPreviousPage}}
            {{#pagination.pageNumbers}}
                <button class="btn btn-outline-secondary pagination-button {{#isActive}}active{{/isActive}}" data-page="{{page}}">
                    {{displayPage}}
                </button>
            {{/pagination.pageNumbers}}
            {{#pagination.hasNextPage}}
                <button class="btn btn-outline-primary pagination-button" data-page="{{pagination.nextPage}}">
                    ë‹¤ìŒ
                </button>
            {{/pagination.hasNextPage}}
        </div>
    </div>
</div>

<script>

    document.addEventListener("DOMContentLoaded", function () {
        // âœ… ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ í´ë¦­ ê°ì§€
        document.addEventListener("click", function (event) {
            const target = event.target.closest(".pagination-button");
            if (!target) return; // pagination ë²„íŠ¼ì´ ì•„ë‹Œ ê²½ìš° ë¬´ì‹œ

            event.preventDefault(); // ê¸°ë³¸ ë™ì‘ ë°©ì§€

            let page = target.getAttribute("data-page");
            if (!page) return;

            let url = `/api/opportunities/ongoing?page=${page}&size=10`;

            // URL ìƒíƒœ ë³€ê²½ (ë’¤ë¡œ ê°€ê¸° ê°€ëŠ¥)
            window.history.pushState({}, "", url);

            // ë°ì´í„°ë¥¼ ë¹„ë™ê¸°ì ìœ¼ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
            loadOpportunities(url);
        });
    });

    function loadOpportunities(url) {
        fetch(url, {
            method: "GET",
            headers: { "X-Requested-With": "XMLHttpRequest" } // AJAX ìš”ì²­ì„ì„ ëª…ì‹œ
        })
        .then(response => response.text())
        .then(html => {
            let parser = new DOMParser();
            let doc = parser.parseFromString(html, "text/html");

            // âœ… í…Œì´ë¸”ë§Œ ì—…ë°ì´íŠ¸ (ëª¨ë‹¬ ì‚­ì œ ë°©ì§€)
            let newTable = doc.querySelector("#datatablesSimple"); // ìƒˆ í…Œì´ë¸” ê°€ì ¸ì˜¤ê¸°
            let newPagination = doc.querySelector(".pagination"); // ìƒˆ í˜ì´ì§€ë„¤ì´ì…˜ ê°€ì ¸ì˜¤ê¸°

            if (newTable) {
                document.querySelector("#datatablesSimple").innerHTML = newTable.innerHTML;
            }
            if (newPagination) {
                document.querySelector(".pagination").innerHTML = newPagination.innerHTML;
            }
        })
        .catch(error => console.error("Error loading opportunities:", error));
    }

    // âœ… ë’¤ë¡œ ê°€ê¸°/ì•ìœ¼ë¡œ ê°€ê¸° ì´ë²¤íŠ¸ ì²˜ë¦¬
    window.addEventListener("popstate", function () {
        loadOpportunities(window.location.href);
    });





            document.addEventListener('click', function(event) {
                    if (event.target.closest('#proposalExcelButton')) { // AIButton í´ë¦­ ê°ì§€
                        try {
                            const selectedCheckboxes = document.querySelectorAll(".select-row:checked");

                            // ğŸ”¹ ì²´í¬ëœ ê°œìˆ˜ í™•ì¸ (1ê°œë§Œ í—ˆìš©)
                            if (selectedCheckboxes.length > 1) {
                                alert("í•˜ë‚˜ì˜ í•­ëª©ë§Œ ì„ íƒí•´ ì£¼ì„¸ìš”.");
                                return;
                            }

                            if (selectedCheckboxes.length === 0) {
                                throw new Error("ì œì•ˆì„œë¥¼ ìƒì„±í•  í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
                            }

                            const selectedRow = selectedCheckboxes[0].closest("tr"); // ì²´í¬ëœ í–‰ ê°€ì ¸ì˜¤ê¸°

                            const employeeId = selectedRow.getAttribute("data-employee") || "ë¯¸ì§€ì •";
                            const productId = selectedRow.getAttribute("data-product") || "ë¯¸ì§€ì •";
                            const opportunityInquiries = selectedRow.getAttribute("data-opportunity-inquiries") || "ìš”êµ¬ì‚¬í•­ ì—†ìŒ";

                            // ğŸ”¹ ì¶”ê°€ëœ ë¡œê·¸
                            console.log("ì„ íƒëœ í–‰ì˜ ë°ì´í„°:", selectedRow.outerHTML);
                            console.log("employeeId:", employeeId);
                            console.log("productId:", productId);
                            console.log("opportunityInquiries:", opportunityInquiries);

                            const dataToSend = {
                                ë‹´ë‹¹ì: employeeId,
                                ì œí’ˆ: productId,
                                ê³ ê°ìš”êµ¬ì‚¬í•­: opportunityInquiries
                            };

                            console.log('ì „ì†¡í•  ë°ì´í„°:', dataToSend);

                            fetch('https://saiescrm.api.jyds.synology.me/generate-excel', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(dataToSend)
                            })
                            .then(response => response.blob())
                            .then(blob => {
                                const url = window.URL.createObjectURL(new Blob([blob]));
                                const link = document.createElement('a');
                                link.href = url;
                                link.setAttribute('download', `proposal.xlsx`);
                                document.body.appendChild(link);
                                link.click();
                                window.URL.revokeObjectURL(url);
                                link.remove();
                                alert('ì œì•ˆì„œ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('ì œì•ˆì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                            });
                        } catch (error) {
                            console.error('Error:', error);
                            alert(error.message);
                        }
                    }
                });


                document.addEventListener('click', function(event) {
                    if (event.target.closest('#proposalButton')) { // AIButton í´ë¦­ ê°ì§€
                        try {
                            const selectedCheckboxes = document.querySelectorAll(".select-row:checked");

                            // ğŸ”¹ ì²´í¬ëœ ê°œìˆ˜ í™•ì¸ (1ê°œë§Œ í—ˆìš©)
                            if (selectedCheckboxes.length > 1) {
                                alert("í•˜ë‚˜ì˜ í•­ëª©ë§Œ ì„ íƒí•´ ì£¼ì„¸ìš”.");
                                return;
                            }

                            if (selectedCheckboxes.length === 0) {
                                throw new Error("ì œì•ˆì„œë¥¼ ìƒì„±í•  í•­ëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");
                            }

                            const selectedRow = selectedCheckboxes[0].closest("tr"); // ì²´í¬ëœ í–‰ ê°€ì ¸ì˜¤ê¸°

                            const employeeId = selectedRow.getAttribute("data-employee") || "ë¯¸ì§€ì •";
                            const productId = selectedRow.getAttribute("data-product") || "ë¯¸ì§€ì •";
                            const opportunityInquiries = selectedRow.getAttribute("data-opportunity-inquiries") || "ìš”êµ¬ì‚¬í•­ ì—†ìŒ";

                            // ğŸ”¹ ì¶”ê°€ëœ ë¡œê·¸
                            console.log("ì„ íƒëœ í–‰ì˜ ë°ì´í„°:", selectedRow.outerHTML);
                            console.log("employeeId:", employeeId);
                            console.log("productId:", productId);
                            console.log("opportunityInquiries:", opportunityInquiries);

                            const dataToSend = {
                                ë‹´ë‹¹ì: employeeId,
                                ì œí’ˆ: productId,
                                ê³ ê°ìš”êµ¬ì‚¬í•­: opportunityInquiries
                            };

                            console.log('ì „ì†¡í•  ë°ì´í„°:', dataToSend);

                            fetch('https://saiescrm.api.jyds.synology.me/generate-ppt', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify(dataToSend)
                            })
                            .then(response => response.blob())
                            .then(blob => {
                                const url = window.URL.createObjectURL(new Blob([blob]));
                                const link = document.createElement('a');
                                link.href = url;
                                link.setAttribute('download', `proposal.pptx`);
                                document.body.appendChild(link);
                                link.click();
                                window.URL.revokeObjectURL(url);
                                link.remove();
                                alert('ì œì•ˆì„œ ë‹¤ìš´ë¡œë“œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
                            })
                            .catch(error => {
                                console.error('Error:', error);
                                alert('ì œì•ˆì„œ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.');
                            });
                        } catch (error) {
                            console.error('Error:', error);
                            alert(error.message);
                        }
                    }
                });


</script>
