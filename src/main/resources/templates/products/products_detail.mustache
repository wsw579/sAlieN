{{>main/header}}

<style>


    /* 진행 상태바 컨테이너 */
.progress-container {
    position: relative;
    width: 100%;
    height: 70px; /* 높이를 조금 늘립니다 */
    margin: 20px 0;
}

.progress-bar {
    position: absolute;
    top: 38%; /* 중앙 정렬 */
    left: 10%; /* Qualification 원의 중앙에서 시작하도록 조정합니다 */
    transform: translateY(-50%);
    width: 0;
    height: 10px;
    background-color: green;
    transition: width 0.4s ease;
}

.progress-steps {
    display: flex;
    justify-content: space-between;
    position: relative;
    width: 100%;
    margin: 20px 0;
}

.step {
    width: 30px;
    height: 30px;
    border: 2px solid #ccc;
    border-radius: 50%;
    display: inline-block;
    position: relative;
    text-align: center;
    line-height: 30px;
    font-weight: bold;
    color: #fff;
    background-color: #ccc;
    transition: background-color 0.3s ease, border-color 0.3s ease;
}

/* 텍스트 스타일 */
.step::after {
    content: attr(data-step);
    position: absolute;
    top: 40px; /* 동그라미 아래에 텍스트 배치 */
    left: 50%;
    transform: translateX(-50%);
    color: #000;
    font-weight: normal;
    font-size: 14px;
}

/* 상태별 동그라미 색상 */

.step.available.active {
    background-color: blue;
    border-color: blue;
}

.step.discontinued.active {
    background-color: gray;
    border-color: gray;
}

.step.out_of_stock.active {
    background-color: red;
    border-color: red;
}
</style>

<div id="layoutSidenav_content">
    <main>
        <div class="container-fluid px-4">
            <h1 class="mt-4">Products</h1>
            <ol class="breadcrumb mb-4">
                <li class="breadcrumb-item active">Products</li>
            </ol>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-table me-1"></i>
                    Products detail
                </div>
                <div class="card-body">

                    <table id="products_detail">
                        {{#products}}
                            <!-- 버튼 컨테이너 -->
                            <div class="button-container mb-3">
                                <a href="/products/detail/create" id="createButton" class="btn btn-custom-create btn-sm">
                                    <i class="fas fa-plus-circle"></i> 신규
                                </a>

                                {{#productId}}
                                    <button id="deleteButton" class="btn btn-custom-delete btn-sm">
                                        <i class="fas fa-trash-alt"></i> 삭제
                                    </button>
                                {{/productId}}
                                <a href="/products" class="btn btn-custom-select btn-sm" id="selectButton">
                                    <i class="fas fa-plus-circle"></i> 목록
                                </a>
                            </div>

                            <!-- 폼 시작 -->
                            {{#productId}}
                            <form id="productForm" action="/products/detail/{{productId}}/update" method="POST">
                            {{/productId}}
                            {{^productId}}
                            <form id="productForm" action="/products/detail/create" method="POST">
                            {{/productId}}

                            <div class="mb-3 row">
                                <label for="productName" class="col-sm-2 col-form-label">제품명:</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="productName" name="productName" value="{{productName}}" required>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label for="category" class="col-sm-2 col-form-label">제품군:</label>
                                <div class="col-sm-10">
                                    <input type="text" class="form-control" id="productFamily" name="productFamily" value="{{productFamily}}" required>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label for="price" class="col-sm-2 col-form-label">원가:</label>
                                <div class="col-sm-10">
                                    <input type="number" class="form-control" id="fixedPrice" name="fixedPrice" value="{{fixedPrice}}" required>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label for="price" class="col-sm-2 col-form-label">딜러가:</label>
                                <div class="col-sm-10">
                                    <input type="number" class="form-control" id="dealerPrice" name="dealerPrice" value="{{dealerPrice}}" required>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label for="price" class="col-sm-2 col-form-label">정찰가:</label>
                                <div class="col-sm-10">
                                    <input type="number" class="form-control" id="costPrice" name="costPrice" value="{{costPrice}}" required>
                                </div>
                            </div>

                            <div class="mb-3 row">
                                <label for="status" class="col-sm-2 col-form-label">상태:</label>
                                <div class="col-sm-10">
                                    <select class="form-control" id="productCondition" name="productCondition" required>
                                        <option value="available">available</option>
                                        <option value="out_of_stock">out_of_stock</option>
                                        <option value="discontinued">discontinued</option>
                                    </select>
                                </div>
                            </div>

                            <div class="d-flex justify-content-end">
                                <button type="submit" id="updateButton" class="btn btn-custom-update btn-sm">
                                    <i class="fas fa-plus-circle"></i> 저장
                                </button>
                            </div>
                        </form> <!-- 폼 닫기 -->
                        {{/products}}
                    </form>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <i class="fas fa-table me-1"></i>
                Product Status
            </div>
            <div class="card-body">
                <table id="products_status">


                    {{#products}}
                        <tbody>
                        <div class="progress-container">
                            <div class="progress-steps">
                                <div class="step available" data-step="available"></div>
                                <div class="step out_of_stock" data-step="out_of_stock"></div>
                                <div class="step discontinued" data-step="discontinued"></div>
                            </div>
                        </div>
                        </tbody>
                    {{/products}}
                </table>
            </div>
        </div>
    </main>

    <script>
    {{#products}}
        document.addEventListener("DOMContentLoaded", function() {
            var productCondition = "{{productCondition}}";

            // 상태에 따른 진행상황 표시
            var progressSteps = document.querySelectorAll(".step");
            var steps = ["available", "out_of_stock", "discontinued"];
            var currentIndex = steps.indexOf(productCondition);

            // 진행상황에 해당하는 동그라미만 채우기
            if (currentIndex !== -1) {
                progressSteps[currentIndex].classList.add("active");
            }

            // 폼에 데이터 채우기
            var productConditionSelect = document.getElementById("productCondition");
            if (productConditionSelect) {
                productConditionSelect.value = productCondition;
            }

            var form = document.getElementById("productForm");
            var currentUrl = window.location.pathname;
            if (form && currentUrl === "/products/detail/create") {
                form.action = "/products/detail/create";
            }

            var updateButton = document.getElementById("updateButton");
            if (updateButton) {
                updateButton.addEventListener("click", function(event) {
                    var confirmSave = confirm("변경사항을 저장하겠습니까?");
                    if (!confirmSave) {
                        event.preventDefault();
                    }
                });
            }

        {{#productId}}
        var deleteButton = document.getElementById("deleteButton");
        if (deleteButton) {
            deleteButton.addEventListener("click", function () {
                // 서버에서 렌더링된 productId 가져오기
                var productId = "{{productId}}";

                if (productId) {
                    var confirmDelete = confirm("현재 항목을 삭제하시겠습니까?");
                    if (confirmDelete) {
                        fetch(`/products/detail/${productId}/delete`, {
                            method: "POST", // 서버 엔드포인트가 POST를 지원해야 함
                            headers: {
                                "Content-Type": "application/json",
                            },
                            body: JSON.stringify({ id: productId }), // 올바른 데이터 전송
                        })
                            .then((response) => {
                                if (response.ok) {
                                    alert("삭제되었습니다.");
                                    window.location.href = "/products"; // 삭제 후 이동
                                } else {
                                    alert("삭제 중 오류가 발생했습니다.");
                                }
                            })
                            .catch((error) => {
                                console.error("Error:", error);
                                alert("삭제 중 오류가 발생했습니다.");
                            });
                    }
                } else {
                    alert("삭제할 ID가 없습니다.");
                }
            });
            }
    {{/productId}}
        });
    {{/products}}
    </script>

    {{>main/footer}}