<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>sAIes CRM</title>
    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
    <link href="/css/main_style.css" rel="stylesheet" />
    <!-- jQuery ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Selectize CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.default.min.css" rel="stylesheet">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
</head>
<body class="sb-nav-fixed">
<nav class="sb-topnav navbar navbar-expand navbar-dark bg-dark">
    <!-- Navbar Brand-->
    <a class="navbar-brand ps-3" href="/">sAIes CRM - KT</a>
    <!-- Sidebar Toggle-->
    <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i class="fas fa-bars"></i></button>

    {{#id}}
        {{#isAdmin}}
            <div class="navbar-text text-light me-3">
                {{id}}ë‹˜ ì˜¤ëŠ˜ í•˜ë£¨ë„ í˜ë‚´ì„¸ìš”.
            </div>  <!-- âœ… ê´€ë¦¬ì: IDë§Œ í‘œì‹œ -->
        {{/isAdmin}}
        {{^isAdmin}}
            <div class="navbar-text text-light me-3">
                {{name}}({{id}})ë‹˜ ì˜¤ëŠ˜ í•˜ë£¨ë„ í˜ë‚´ì„¸ìš”.
            </div> <!-- âœ… ì¼ë°˜ ì‚¬ìš©ì: ì´ë¦„ + ID í‘œì‹œ -->
        {{/isAdmin}}
    {{/id}}


    <!-- Navbar Search-->
    <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">
        <div class="input-group">
<!--            <input class="form-control" type="text" placeholder="Search for..." aria-label="Search for..." aria-describedby="btnNavbarSearch" />-->
<!--            <button class="btn btn-primary" id="btnNavbarSearch" type="button"><i class="fas fa-search"></i></button>-->
        </div>
    </form>

    <!-- profile-->
    <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user fa-fw"></i></a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item" href="/mypage/{{id}}">MyPage</a></li>
                <li><hr class="dropdown-divider" /></li>
                <li><a class="dropdown-item" href="/logout">Logout</a></li>
            </ul>
        </li>
    </ul>




</nav>



<div id="layoutSidenav">
    <div id="layoutSidenav_nav">
        <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
            <div class="sb-sidenav-menu">
                <div class="nav">


                    <div class="sb-sidenav-menu-heading">Main</div>
                    <a class="nav-link" href="/">
                        <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                        Main
                    </a>



                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseCS" aria-expanded="false" aria-controls="collapseCS">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                        CS
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseCS" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">

                            <a class="nav-link" href="/leads">Leads</a>
                            <a class="nav-link" href="/account">Accounts</a>

                        </nav>
                    </div>




                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseSales" aria-expanded="false" aria-controls="collapseSales">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                        Sales
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseSales" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">

                            <a class="nav-link" href="/leads">Leads</a>
                            <a class="nav-link" href="/account">Accounts</a>
                            <a class="nav-link" href="/opportunities">Opportunities</a>
                            <a class="nav-link" href="/contracts">Contracts</a>
                            <a class="nav-link" href="/orders">Orders</a>
                            <a class="nav-link" href="/calendar">Calendar</a>

                        </nav>
                    </div>



                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseMarketing" aria-expanded="false" aria-controls="collapseMarketing">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                        Marketing
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseMarketing" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">

                            <a class="nav-link" href="/account">Accounts</a>
                            <a class="nav-link" href="/products">Products</a>
                        </nav>
                    </div>



                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseSCM" aria-expanded="false" aria-controls="collapseSCM">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                        SCM
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseSCM" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">

                            <a class="nav-link" href="/orders">Orders</a>
                            <a class="nav-link" href="/products">Products</a>
                        </nav>
                    </div>



                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseINFO" aria-expanded="false" aria-controls="collapseINFO">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                        Member
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseINFO" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                            <a class="nav-link" href="/employee-list">Employee Directory</a>
                        </nav>
                    </div>

                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseLogs" aria-expanded="false" aria-controls="collapseLogs">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                        Logs
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseLogs" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                            <a class="nav-link" href="/chatbot_logs">Chatbot Logs</a>
                            <a class="nav-link" href="/crud_logs">CRUD Logs</a>

                        </nav>
                    </div>



                </div>
            </div>
            <div class="sb-sidenav-footer">
                <div class="small">Logged in as:</div>
                sAies CRM
            </div>
        </nav>
    </div>





    <!-- Add this after the existing HTML code -->
    <style>
        /* Add this CSS to your main CSS file */
        .chatbot-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 50%; /* Center horizontally */
            top: 50%; /* Center vertically */
            transform: translate(-50%, -50%); /* Center the modal */
            width: 50%; /* Width of modal */
            max-width: 600px;
            height: auto;
            background-color: rgb(0, 0, 0); /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-modal-content {
            background-color: #fefefe;
            padding: 0; /* Remove padding to adjust for title bar */
            border: 1px solid #888;
            width: 100%;
            max-height: 80vh; /* Max height of modal */
            overflow-y: auto; /* Enable scroll if needed */
            display: flex;
            flex-direction: column;
        }

        .chatbot-title-bar {
            background-color: #007bff;
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            margin-right: 10px;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .user-message, .bot-message {
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            display: inline-block;
            max-width: 70%;
        }

        .user-message {
            text-align: right;
            background-color: #dcf8c6;
            align-self: flex-end; /* Align user message to the right */
        }

        .bot-message {
            text-align: left;
            background-color: #f1f1f1;
            align-self: flex-start; /* Align bot message to the left */
        }

        .message-info {
            font-size: 12px;
            color: #555;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .input-container {
            display: flex;
            padding: 10px;
        }

        .user-info {
            text-align: right;
        }

        .bot-info {
            text-align: left;
        }

        #chatbotInput {
            flex: 1;
            padding: 10px;
            margin-right: 10px;
        }

        #sendChatbotMessage {
            display: none;
        }



        .button-container {
        display: flex;
        justify-content: flex-end; /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
        gap: 10px; /* ë²„íŠ¼ ê°„ê²© */
        }
        .btn-custom-create {
            background-color: #007bff; /* ë¸”ë£¨ */
            border-color: #c3e6cb;
            color: #ffffffe3;
        }
        .btn-custom-delete {
            background-color: #ef1325e6; /* ë ˆë“œ */
            border-color: #f5c6cb;
            color: #ffffffe3;
        }
        .btn-custom-select {
            background-color: #0ea134; /* ê·¸ë¦° */
            border-color: #f5c6cb;
            color: #ffffffe3;
        }
        .btn-custom-update {
            background-color: #0ab3d9; /* ì²­ë¡ */
            border-color: #f5c6cb;
            color: #ffffffe3;
        }

        .btn-custom-create:hover {
            background-color: #0d4e95; /* ì–´ë‘ìš´ ë¸”ë£¨ */
            border-color: #b1dfbb;
            color: #ffffffe3;
        }
        .btn-custom-delete:hover {
            background-color: #9b0c18e6; /* ì–´ë‘ìš´ ë ˆë“œ */
            border-color: #8b0b16e6;
            color: #ffffffe3;
        }
        .btn-custom-select:hover {
            background-color: #097d27; /* ì–´ë‘ìš´ ê·¸ë¦° */
            border-color: #8b0b16e6;
            color: #ffffffe3;
        }
        .btn-custom-update:hover {
            background-color: #0885a1; /* ì–´ë‘ìš´ ì²­ë¡ */
            border-color: #8b0b16e6;
            color: #ffffffe3;
        }
        .btn-sm {
            font-size: 0.875rem; /* ë²„íŠ¼ í°íŠ¸ í¬ê¸° ê°ì†Œ */
            padding: 0.25rem 0.5rem; /* íŒ¨ë”© ê°ì†Œ */
        }


        .container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        .col-form-label {
            font-weight: bold;
        }
        .btn-primary {
            background-color: #6c757d;
            border: none;
        }
        .btn-primary:hover {
            background-color: #5a6268;
        }



    </style>

    <!-- Chatbot Button -->
    <div id="chatbotButton" style="position: fixed; bottom: 20px; right: 20px; z-index: 1000; width: 60px; height: 60px; background-color: #007bff; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px;">
        ğŸ’¬
    </div>

    <!-- íš¨ê³¼ìŒ -->
    <audio id="dingup" src="/assets/mp3/dingup.mp3"></audio>
    <audio id="dingdown" src="/assets/mp3/dingdown.mp3"></audio>


    <!-- Chatbot Modal -->
    <div id="chatbotModal" class="chatbot-modal">
        <div class="chatbot-modal-content">
            <div class="chatbot-title-bar">
                sAIes CRM chat bot
                <span class="close">&times;</span>
            </div>
            <div id="chatbotMessages" class="chat-container"></div>
            <div class="input-container">
                <input type="text" id="chatbotInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeydown="if (event.key === 'Enter') sendChatbotMessage();">
                <button id="voiceInputButton", class= "btn btn-custom-select btn-sm"><i class="fas fa-microphone"></i></button>
                <button id="sendChatbotMessage">Send</button>
            </div>
        </div>
    </div>ï¸


<!-- JavaScript -->
    <script>
        document.addEventListener("DOMContentLoaded", function() {

            var chatbotButton = document.getElementById('chatbotButton');
            var chatbotModal = document.getElementById('chatbotModal');
            var closeModal = document.getElementsByClassName('close')[0];

            chatbotModal.style.display = "none";

            chatbotButton.onclick = function() {
                chatbotModal.style.display = "block";
                initializeChat(); // ëª¨ë‹¬ì´ ì—´ë¦´ ë•Œ ì´ˆê¸° ë©”ì‹œì§€ ì¶”ê°€
            }

            closeModal.onclick = function() {
                chatbotModal.style.display = "none";
            }

            var recognition;
            var recognizing = false;
            var timeoutId;
            var finalTranscript = '';

            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'ko-KR';

                recognition.onstart = function() {
                    recognizing = true;
                    document.getElementById('dingup').play();
                    console.log('Speech recognition started');
                };

                recognition.onresult = function(event) {
                    clearTimeout(timeoutId); // Clear the timeout if there's any speech input
                    var interimTranscript = '';
                    for (var i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    document.getElementById('chatbotInput').value = finalTranscript + interimTranscript;
                    timeoutId = setTimeout(function() {
                        if (recognizing) {
                            recognition.stop();
                        }
                    }, 1000); // Stop recognition after 1 seconds of silence
                };

                recognition.onerror = function(event) {
                    console.log('Speech recognition error', event);
                    recognizing = false;
                };

                recognition.onend = function() {
                    recognizing = false;
                    document.getElementById('chatbotInput').value = finalTranscript; // Ensure the final transcript remains
                    document.getElementById('dingdown').play();
                    console.log('Speech recognition ended');

                    //ìŒì„± ì¸ì‹ ë©”ì‹œì§€ ìë™ ì „ì†¡
                    sendChatbotMessage();


                };

                //ìŒì„±ì¸ì‹ë²„íŠ¼ í´ë¦­
                document.getElementById('voiceInputButton').onclick = function() {

                    if (recognizing) {
                        recognition.stop();
                    } else {
                        finalTranscript = document.getElementById('chatbotInput').value; // Reset the final transcript to current input
                        recognition.start();
                    }
                };
            } else {
                console.log('Speech recognition not supported');
            }

            var sendChatbotMessage = function() {
                if (recognizing) {
                    recognition.stop();
                }
                var user_id = '{{#id}}{{id}}{{/id}}{{^id}}null{{/id}}';
                var message = document.getElementById('chatbotInput').value;
                var currentTime = new Date().toLocaleTimeString();

                var userMessage = "<div class='chat-container'><div class='user-info message-info'>User</div><div class='user-message'>" + message + "<br><span class='message-info'>" + currentTime + "</span></div></div>";

                document.getElementById('chatbotMessages').innerHTML += userMessage;
                document.getElementById('chatbotInput').value = "";
                finalTranscript = ''; // Reset the final transcript after sending the message

                setTimeout(function() {
                    document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;
                }, 100); // ë”œë ˆì´ ì¡°ì • ê°€ëŠ¥

                // API í˜¸ì¶œ ë¶€ë¶„
                fetch('https://saiescrm.api.jyds.synology.me/chatbot', { // ì„œë²„
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ request: message, user_id: user_id })
                })
                .then(response => response.json())
                .then(data => {
                    // \n ë¬¸ìë¥¼ <br> íƒœê·¸ë¡œ ëŒ€ì²´
                    var formattedResponse = data.response.replace(/\\n/g, '<br>');
                    var botMessage = "<div class='chat-container'><div class='bot-info message-info'>sAIes CRM</div><div class='bot-message'>" + formattedResponse + "<br><span class='message-info'>" + currentTime + "</span></div></div>";
                    document.getElementById('chatbotMessages').innerHTML += botMessage;

                    // ëª¨ë‹¬ ì°½ ë‚´ì˜ ìŠ¤í¬ë¡¤ ìµœí•˜ë‹¨ìœ¼ë¡œ ë‚´ë¦¬ê¸°
                    setTimeout(function() {
                        document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;
                    }, 100); // ë”œë ˆì´ ì¡°ì • ê°€ëŠ¥

                    // TTS API í˜¸ì¶œ ë¶€ë¶„
                    // ì¤„ë°”ê¿ˆ ë¬¸ìë¥¼ ì œê±°í•˜ê³  JSON í˜•ì‹ì˜ í…ìŠ¤íŠ¸ë¥¼ ì§€ì›Œì„œ í¬ë§·íŒ…
                    var normalizedResponse = formattedResponse.replace(/\\n/g, ' ').replace(/\n/g, ' ').replace(/{[^{}]*}/g, '').replace(/<br>/g, '');

                    //fetch('http://127.0.0.1:8000/tts', {
                    fetch('https://saiescrm.tts.jyds.synology.me/tts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ request: normalizedResponse, user_id: user_id })
                    })
                    .then(response => {
                        if (response.ok) {
                            return response.blob();
                        } else {
                            throw new Error('TTS API í˜¸ì¶œ ì‹¤íŒ¨');
                        }
                    })
                    .then(blob => {
                        var audioUrl = URL.createObjectURL(blob);
                        var audio = new Audio(audioUrl);
                        audio.play();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        var botMessage = "<div class='chat-container'><div class='bot-info message-info'>sAIes CRM</div><div class='bot-message'>TTS API í˜¸ì¶œ ì˜¤ë¥˜: " + error.message + "<br><span class='message-info'>" + currentTime + "</span></div></div>";
                        document.getElementById('chatbotMessages').innerHTML += botMessage;
                        setTimeout(function() {
                            document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;
                        }, 100); // ë”œë ˆì´ ì¡°ì • ê°€ëŠ¥
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    var botMessage = "<div class='chat-container'><div class='bot-info message-info'>sAIes CRM</div><div class='bot-message'>API í˜¸ì¶œ ì˜¤ë¥˜: " + error.message + "<br><span class='message-info'>" + currentTime + "</span></div></div>";
                    document.getElementById('chatbotMessages').innerHTML += botMessage;
                    setTimeout(function() {
                        document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;
                    }, 100); // ë”œë ˆì´ ì¡°ì • ê°€ëŠ¥
                });
            }


            document.getElementById('chatbotInput').onkeydown = function(event) {
                if (event.key === 'Enter') {
                    sendChatbotMessage();
                    setTimeout(function() {
                        document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;
                    }, 100); // Adjust the delay as needed
                }
            };

            // ì´ˆê¸° ë©”ì‹œì§€ë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
            var initializeChat = function() {
                var initialMessage = "<div class='chat-container'><div class='bot-info message-info'>sAIes CRM</div><div class='bot-message'>ì•ˆë…•í•˜ì„¸ìš”. CRM ì–´ì‹œìŠ¤ë˜íŠ¸ ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?<br><span class='message-info'>" + new Date().toLocaleTimeString() + "</span></div></div>";
                document.getElementById('chatbotMessages').innerHTML = initialMessage;
            };











        });
    </script>