<!DOCTYPE html>
<html lang="ko">

<style>
    .sb-topnav,
    .sb-sidenav-dark,
    .sb-sidenav-footer {
        background-color: #141b2f !important;
    }
</style>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <meta name="description" content="" />
    <meta name="author" content="" />
    <title>sAIien</title>
    <link href="https://cdn.jsdelivr.net/npm/simple-datatables@7.1.2/dist/style.min.css" rel="stylesheet" />
    <link href="/css/main_style.css" rel="stylesheet" />
    <!-- jQuery ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Selectize CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/selectize.js/0.12.6/css/selectize.default.min.css" rel="stylesheet">
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


    <script src="https://use.fontawesome.com/releases/v6.3.0/js/all.js" crossorigin="anonymous"></script>
</head>
<body class="sb-nav-fixed">
<nav class="sb-topnav navbar navbar-expand navbar-dark">
    <!-- Navbar Brand-->
    <a class="navbar-brand ps-3" href="/">sAIien - KT</a>
    <!-- Sidebar Toggle-->
    <button class="btn btn-link btn-sm order-1 order-lg-0 me-4 me-lg-0" id="sidebarToggle" href="#!"><i class="fas fa-bars"></i></button>

    {{#id}}
        {{#isAdmin}}
            <div class="navbar-text text-light me-3">
                {{id}}ë‹˜ ì˜¤ëŠ˜ í•˜ë£¨ë„ í˜ë‚´ì„¸ìš”.
            </div>  <!-- âœ… ê´€ë¦¬ì: IDë§Œ í‘œì‹œ -->
        {{/isAdmin}}
        {{^isAdmin}}
            <div class="navbar-text text-light me-3">
                {{name}}({{id}})ë‹˜ ì˜¤ëŠ˜ í•˜ë£¨ë„ í˜ë‚´ì„¸ìš”.
            </div> <!-- âœ… ì¼ë°˜ ì‚¬ìš©ì: ì´ë¦„ + ID í‘œì‹œ -->
        {{/isAdmin}}
    {{/id}}


    <!-- Navbar Search-->
    <form class="d-none d-md-inline-block form-inline ms-auto me-0 me-md-3 my-2 my-md-0">
        <div class="input-group">
<!--            <input class="form-control" type="text" placeholder="Search for..." aria-label="Search for..." aria-describedby="btnNavbarSearch" />-->
<!--            <button class="btn btn-primary" id="btnNavbarSearch" type="button"><i class="fas fa-search"></i></button>-->
        </div>
    </form>

    <!-- ìš”ê¸ˆì œ -->
    <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">Basic Plan ì‚¬ìš©ì¤‘</a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item" href="/rate_plan">ìš”ê¸ˆì œ ë³€ê²½</a></li>
            </ul>
        </li>
    </ul>

    <!-- profile-->
    <ul class="navbar-nav ms-auto ms-md-0 me-3 me-lg-4">
        <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" id="navbarDropdown" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false"><i class="fas fa-user fa-fw"></i></a>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                <li><a class="dropdown-item" href="/mypage/{{id}}">MyPage</a></li>
                <li><hr class="dropdown-divider" /></li>
                <li><a class="dropdown-item" href="/logout">Logout</a></li>
            </ul>
        </li>
    </ul>




</nav>



<div id="layoutSidenav">
    <div id="layoutSidenav_nav">
        <nav class="sb-sidenav accordion sb-sidenav-dark" id="sidenavAccordion">
            <div class="sb-sidenav-menu">
                <div class="nav">


                    <div class="sb-sidenav-menu-heading">Main</div>
                    <a class="nav-link" href="/">
                        <div class="sb-nav-link-icon"><i class="fas fa-tachometer-alt"></i></div>
                        Main
                    </a>



                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseCS" aria-expanded="false" aria-controls="collapseCS">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                        CS
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseCS" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">

                            <a class="nav-link" href="/leads">Leads</a>
                            <a class="nav-link" href="/account">Accounts</a>

                        </nav>
                    </div>




                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseSales" aria-expanded="false" aria-controls="collapseSales">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                        Sales
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseSales" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">

                            <a class="nav-link" href="/leads">Leads</a>
                            <a class="nav-link" href="/account">Accounts</a>
                            <a class="nav-link" href="/opportunities">Opportunities</a>
                            <a class="nav-link" href="/contracts">Contracts</a>
                            <a class="nav-link" href="/orders">Orders</a>
                            <a class="nav-link" href="/calendar">Calendar</a>

                        </nav>
                    </div>



                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseMarketing" aria-expanded="false" aria-controls="collapseMarketing">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                        Marketing
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseMarketing" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">

                            <a class="nav-link" href="/account">Accounts</a>
                            <a class="nav-link" href="/products">Products</a>
                        </nav>
                    </div>



                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseSCM" aria-expanded="false" aria-controls="collapseSCM">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                        SCM
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseSCM" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">

                            <a class="nav-link" href="/orders">Orders</a>
                            <a class="nav-link" href="/products">Products</a>
                        </nav>
                    </div>



                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseINFO" aria-expanded="false" aria-controls="collapseINFO">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                        Member
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseINFO" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                            <a class="nav-link" href="/employee-list">Employee Directory</a>
                        </nav>
                    </div>

                    <a class="nav-link collapsed" href="#" data-bs-toggle="collapse" data-bs-target="#collapseLogs" aria-expanded="false" aria-controls="collapseLogs">
                        <div class="sb-nav-link-icon"><i class="fas fa-columns"></i></div>
                        Logs
                        <div class="sb-sidenav-collapse-arrow"><i class="fas fa-angle-down"></i></div>
                    </a>
                    <div class="collapse" id="collapseLogs" aria-labelledby="headingOne" data-bs-parent="#sidenavAccordion">
                        <nav class="sb-sidenav-menu-nested nav">
                            <a class="nav-link" href="/chatbot_logs">Chatbot Logs</a>
                            <a class="nav-link" href="/crud_logs">CRUD Logs</a>

                        </nav>
                    </div>



                </div>
            </div>
            <div class="sb-sidenav-footer">
                <div class="small">Logged in as:</div>
                sAIien
            </div>
        </nav>
    </div>





    <!-- Add this after the existing HTML code -->
    <style>
        /* Add this CSS to your main CSS file */
        .chatbot-modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 50%; /* Center horizontally */
            top: 50%; /* Center vertically */
            transform: translate(-50%, -50%); /* Center the modal */
            width: 50%; /* Width of modal */
            max-width: 600px;
            height: auto;
            background-color: rgb(0, 0, 0); /* Fallback color */
            background-color: rgba(0, 0, 0, 0.4); /* Black w/ opacity */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .chatbot-modal-content {
            background-color: #fefefe;
            padding: 0; /* Remove padding to adjust for title bar */
            border: 1px solid #888;
            width: 100%;
            max-height: 80vh; /* Max height of modal */
            overflow-y: auto; /* Enable scroll if needed */
            display: flex;
            flex-direction: column;
        }

        .chatbot-title-bar {
            background-color: #007bff;
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 18px;
            font-weight: bold;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            margin-right: 10px;
        }

        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        .user-message, .bot-message {
            border-radius: 10px;
            padding: 10px;
            margin: 10px 0;
            display: inline-block;
            max-width: 70%;
        }

        .user-message {
            text-align: right;
            background-color: #dcf8c6;
            align-self: flex-end; /* Align user message to the right */
        }

        .bot-message {
            text-align: left;
            background-color: #f1f1f1;
            align-self: flex-start; /* Align bot message to the left */
        }

        .message-info {
            font-size: 12px;
            color: #555;
        }

        .chat-container {
            display: flex;
            flex-direction: column;
            padding: 10px;
        }

        .input-container {
            display: flex;
            padding: 10px;
        }

        .user-info {
            text-align: right;
        }

        .bot-info {
            text-align: left;
        }

        #chatbotInput {
            flex: 1;
            padding: 10px;
            margin-right: 10px;
        }

        #sendChatbotMessage {
            display: none;
        }



        .button-container {
        display: flex;
        justify-content: flex-end; /* ì˜¤ë¥¸ìª½ ì •ë ¬ */
        gap: 10px; /* ë²„íŠ¼ ê°„ê²© */
        }
        .btn-custom-create {
            background-color: #007bff; /* ë¸”ë£¨ */
            border-color: #c3e6cb;
            color: #ffffffe3;
        }
        .btn-custom-delete {
            background-color: #ef1325e6; /* ë ˆë“œ */
            border-color: #f5c6cb;
            color: #ffffffe3;
        }
        .btn-custom-select {
            background-color: #0ea134; /* ê·¸ë¦° */
            border-color: #f5c6cb;
            color: #ffffffe3;
        }
        .btn-custom-update {
            background-color: #0ab3d9; /* ì²­ë¡ */
            border-color: #f5c6cb;
            color: #ffffffe3;
        }

        .btn-custom-create:hover {
            background-color: #0d4e95; /* ì–´ë‘ìš´ ë¸”ë£¨ */
            border-color: #b1dfbb;
            color: #ffffffe3;
        }
        .btn-custom-delete:hover {
            background-color: #9b0c18e6; /* ì–´ë‘ìš´ ë ˆë“œ */
            border-color: #8b0b16e6;
            color: #ffffffe3;
        }
        .btn-custom-select:hover {
            background-color: #097d27; /* ì–´ë‘ìš´ ê·¸ë¦° */
            border-color: #8b0b16e6;
            color: #ffffffe3;
        }
        .btn-custom-update:hover {
            background-color: #0885a1; /* ì–´ë‘ìš´ ì²­ë¡ */
            border-color: #8b0b16e6;
            color: #ffffffe3;
        }
        .btn-sm {
            font-size: 0.875rem; /* ë²„íŠ¼ í°íŠ¸ í¬ê¸° ê°ì†Œ */
            padding: 0.25rem 0.5rem; /* íŒ¨ë”© ê°ì†Œ */
        }


        .container {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
        }
        .col-form-label {
            font-weight: bold;
        }
        .btn-primary {
            background-color: #6c757d;
            border: none;
        }
        .btn-primary:hover {
            background-color: #5a6268;
        }

        /* ê¸°ë³¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #chatbotButton {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            width: 80px;
            height: 80px;
            border-radius: 50%;
            cursor: grab; /* ê¸°ë³¸ì ìœ¼ë¡œ grab ì»¤ì„œ */
            overflow: hidden;
            transition: box-shadow 0.2s;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            background-color: white;
        }

        #chatbotButton img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none; /* âœ… ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë¯¸ì§€ ë“œë˜ê·¸ ë°©ì§€ */
        }

        /* ë“œë˜ê·¸ ì¤‘ì¼ ë•Œ ìŠ¤íƒ€ì¼ */
        #chatbotButton.dragging {
            cursor: grabbing !important; /* ë“œë˜ê·¸ ì¤‘ grabbing ìœ ì§€ */
            opacity: 0.8; /* ì‹œê°ì ìœ¼ë¡œ ë“œë˜ê·¸ ì¤‘ì„ì„ ê°•ì¡° */
        }
    </style>

    <!-- ì±—ë´‡ ë²„íŠ¼ -->
    <div id="chatbotButton">
        <img src="/assets/img/chatbot.png" alt="AI ì±—ë´‡">
    </div>

    <!-- íš¨ê³¼ìŒ -->
    <audio id="dingup" src="/assets/mp3/dingup.mp3"></audio>
    <audio id="dingdown" src="/assets/mp3/dingdown.mp3"></audio>


    <!-- Chatbot Modal -->
    <div id="chatbotModal" class="chatbot-modal">
        <div class="chatbot-modal-content">
            <div class="chatbot-title-bar">
                sAIien chat bot
                <span class="close">&times;</span>
            </div>
            <div id="chatbotMessages" class="chat-container"></div>
            <div class="input-container">
                <input type="text" id="chatbotInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeydown="if (event.key === 'Enter') sendChatbotMessage();">
                <button id="voiceInputButton", class= "btn btn-custom-select btn-sm"><i class="fas fa-microphone"></i></button>
                <button id="sendChatbotMessage">Send</button>
            </div>
        </div>
    </div>ï¸


<!-- JavaScript -->
    <script>

        // ì±—ë´‡ ë²„íŠ¼
        document.addEventListener("DOMContentLoaded", function () {
    const chatbotButton = document.getElementById("chatbotButton");
    const chatbotModal = document.getElementById("chatbotModal");
    const closeModal = document.getElementsByClassName("close")[0];

});

        document.addEventListener("DOMContentLoaded", function() {

            var chatbotButton = document.getElementById('chatbotButton');
            var chatbotModal = document.getElementById('chatbotModal');
            var closeModal = document.getElementsByClassName('close')[0];

            let isDragging = false;
            let isClick = false; // âœ… í´ë¦­ ì—¬ë¶€ í™•ì¸ ë³€ìˆ˜
            let offsetX, offsetY;

            // âœ… ì´ˆê¸° ìœ„ì¹˜ ë¹„ìœ¨ ì €ì¥
            let xRatio = chatbotButton.offsetLeft / document.documentElement.clientWidth;
            let yRatio = chatbotButton.offsetTop / document.documentElement.clientHeight;

            function adjustButtonPosition() {
                // âœ… í˜„ì¬ ë¹„ìœ¨ì„ ìœ ì§€í•˜ë©´ì„œ ìƒˆë¡œìš´ ìœ„ì¹˜ ê³„ì‚° (ìŠ¤í¬ë¡¤ ë°” ì œì™¸)
                let newX = xRatio * document.documentElement.clientWidth;
                let newY = yRatio * document.documentElement.clientHeight;

                // âœ… ë²„íŠ¼ì´ í™”ë©´ì„ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ë³´ì •
                const maxX = document.documentElement.clientWidth - chatbotButton.offsetWidth;
                const maxY = document.documentElement.clientHeight - chatbotButton.offsetHeight;

                chatbotButton.style.left = `${Math.max(0, Math.min(maxX, newX))}px`;
                chatbotButton.style.top = `${Math.max(0, Math.min(maxY, newY))}px`;
            }

            function startDrag(e) {
                e.preventDefault();
                isDragging = true;
                isClick = true; // âœ… í´ë¦­ìœ¼ë¡œ ì‹œì‘
                chatbotButton.classList.add("dragging");
                chatbotButton.style.cursor = "grabbing";

                let clientX = e.clientX || e.touches[0].clientX;
                let clientY = e.clientY || e.touches[0].clientY;

                offsetX = clientX - chatbotButton.getBoundingClientRect().left;
                offsetY = clientY - chatbotButton.getBoundingClientRect().top;

                chatbotButton.style.transition = "none";

                document.addEventListener("mousemove", moveDrag);
                document.addEventListener("touchmove", moveDrag);
            }

            function moveDrag(e) {
                if (!isDragging) return;
                isClick = false; // âœ… ë“œë˜ê·¸ê°€ ë°œìƒí•˜ë©´ í´ë¦­ì´ ì•„ë‹˜

                let clientX = e.clientX || e.touches[0].clientX;
                let clientY = e.clientY || e.touches[0].clientY;

                let x = clientX - offsetX;
                let y = clientY - offsetY;

                const maxX = document.documentElement.clientWidth - chatbotButton.offsetWidth;
                const maxY = document.documentElement.clientHeight - chatbotButton.offsetHeight;

                x = Math.max(0, Math.min(maxX, x));
                y = Math.max(0, Math.min(maxY, y));

                chatbotButton.style.left = `${x}px`;
                chatbotButton.style.top = `${y}px`;
                chatbotButton.style.right = "auto";
                chatbotButton.style.bottom = "auto";
                chatbotButton.style.position = "fixed";
            }

            function stopDrag() {
                if (!isDragging) return;

                isDragging = false;
                chatbotButton.classList.remove("dragging");
                chatbotButton.style.cursor = "grab";
                chatbotButton.style.transition = "box-shadow 0.2s";

                document.removeEventListener("mousemove", moveDrag);
                document.removeEventListener("touchmove", moveDrag);

                // âœ… í˜„ì¬ ìœ„ì¹˜ë¥¼ ë¹„ìœ¨ë¡œ ë³€í™˜í•˜ì—¬ ì €ì¥
                xRatio = chatbotButton.offsetLeft / document.documentElement.clientWidth;
                yRatio = chatbotButton.offsetTop / document.documentElement.clientHeight;

                setTimeout(() => {
                    isClick = false; // âœ… ë“œë˜ê·¸ í›„ ë†“ìœ¼ë©´ í´ë¦­ ì´ë²¤íŠ¸ ì‹¤í–‰ ë°©ì§€
                }, 0);
            }

            function openChatbot(e) {
                if (!isClick) {
                    return;
                }
                chatbotModal.style.display = "block"; // âœ… ì±—ë´‡ ëª¨ë‹¬ ì—´ê¸°
                initializeChat(); // âœ… ì±—ë´‡ ì´ˆê¸°í™” í•¨ìˆ˜ ì‹¤í–‰
            }

            function closeChatbot() {
                chatbotModal.style.display = "none";
            }

            chatbotButton.addEventListener("mousedown", (e) => {
                startDrag(e);
            });

            chatbotButton.addEventListener("touchstart", (e) => {
                startDrag(e);
            });

            document.addEventListener("mouseup", stopDrag);
            document.addEventListener("touchend", stopDrag);

            // âœ… ê¸°ì¡´ `handleClick` â†’ `openChatbot`ìœ¼ë¡œ ë³€ê²½í•˜ì—¬ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            chatbotButton.addEventListener("click", openChatbot);

            // âœ… ì±—ë´‡ ë‹«ê¸° ë²„íŠ¼ ì´ë²¤íŠ¸ ì¶”ê°€
            closeModal.addEventListener("click", closeChatbot);

            // âœ… ì°½ í¬ê¸°ê°€ ë³€ê²½ë  ë•Œ ë²„íŠ¼ ìœ„ì¹˜ë¥¼ ë¹„ìœ¨ì— ë§ê²Œ ìë™ ì¡°ì •
            window.addEventListener("resize", adjustButtonPosition);

            // âœ… í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸° ë²„íŠ¼ ìœ„ì¹˜ ì¡°ì •
            adjustButtonPosition();

            chatbotModal.style.display = "none";



            closeModal.onclick = function() {
                chatbotModal.style.display = "none";
            }

            var recognition;
            var recognizing = false;
            var timeoutId;
            var finalTranscript = '';

            if ('webkitSpeechRecognition' in window) {
                recognition = new webkitSpeechRecognition();
                recognition.continuous = true;
                recognition.interimResults = true;
                recognition.lang = 'ko-KR';

                recognition.onstart = function() {
                    recognizing = true;
                    document.getElementById('dingup').play();
                    console.log('Speech recognition started');
                };

                recognition.onresult = function(event) {
                    clearTimeout(timeoutId); // Clear the timeout if there's any speech input
                    var interimTranscript = '';
                    for (var i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    document.getElementById('chatbotInput').value = finalTranscript + interimTranscript;
                    timeoutId = setTimeout(function() {
                        if (recognizing) {
                            recognition.stop();
                        }
                    }, 1000); // Stop recognition after 1 seconds of silence
                };

                recognition.onerror = function(event) {
                    console.log('Speech recognition error', event);
                    recognizing = false;
                };

                recognition.onend = function() {
                    recognizing = false;
                    document.getElementById('chatbotInput').value = finalTranscript; // Ensure the final transcript remains
                    document.getElementById('dingdown').play();
                    console.log('Speech recognition ended');

                    //ìŒì„± ì¸ì‹ ë©”ì‹œì§€ ìë™ ì „ì†¡
                    sendChatbotMessage();


                };

                //ìŒì„±ì¸ì‹ë²„íŠ¼ í´ë¦­
                document.getElementById('voiceInputButton').onclick = function() {

                    if (recognizing) {
                        recognition.stop();
                    } else {
                        finalTranscript = document.getElementById('chatbotInput').value; // Reset the final transcript to current input
                        recognition.start();
                    }
                };
            } else {
                console.log('Speech recognition not supported');
            }

            var sendChatbotMessage = function() {
                if (recognizing) {
                    recognition.stop();
                }
                var user_id = '{{#id}}{{id}}{{/id}}{{^id}}null{{/id}}';
                var message = document.getElementById('chatbotInput').value;
                var currentTime = new Date().toLocaleTimeString();

                var userMessage = "<div class='chat-container'><div class='user-info message-info'>User</div><div class='user-message'>" + message + "<br><span class='message-info'>" + currentTime + "</span></div></div>";

                document.getElementById('chatbotMessages').innerHTML += userMessage;
                document.getElementById('chatbotInput').value = "";
                finalTranscript = ''; // Reset the final transcript after sending the message

                setTimeout(function() {
                    document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;
                }, 100); // ë”œë ˆì´ ì¡°ì • ê°€ëŠ¥

                // API í˜¸ì¶œ ë¶€ë¶„

                fetch('http://127.0.0.1:8000/chatbot', { // ë¡œì»¬
                //fetch('https://saiescrm.api.jyds.synology.me/chatbot', { // ì„œë²„
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ request: message, user_id: user_id })
                })
                .then(response => response.json())
                .then(data => {
                    // // \n ë¬¸ìë¥¼ <br> íƒœê·¸ë¡œ ëŒ€ì²´
                    // var formattedResponse = data.response.replace(/\\n/g, '<br>');


                    var formattedResponse = "";

                    if(data.crudOperations === "normal"){
                        formattedResponse += data.response.replace(/\\n/g, '<br>');
                    }

                    // 2. system_response ê°’ì„ JSON ê°ì²´ë¡œ ë³€í™˜
                    var systemData = {};
                    if (data.system_response) {
                        try {
                            // âœ… \\_ ì œê±° ë° ë°±ìŠ¬ë˜ì‹œ ì •ë¦¬
                            let cleanedJson = data.system_response
                                    .replace(/\\\\/g, '\\')  // ì´ì¤‘ ë°±ìŠ¬ë˜ì‹œ ì •ë¦¬
                                    .replace(/\\_/g, '_')    // ì˜ëª»ëœ ì´ìŠ¤ì¼€ì´í”„ ë¬¸ì ì œê±°
                                    .replace(/\\n/g, '');    // ê°œí–‰ ë¬¸ì ì •ë¦¬

                            console.log("ğŸ“Œ ì •ë¦¬ëœ JSON ë¬¸ìì—´:", cleanedJson);

                            // âœ… JSON ë³€í™˜
                            systemData = JSON.parse(cleanedJson);
                        } catch (e) {
                            console.error("âŒ system_response JSON íŒŒì‹± ì˜¤ë¥˜:", e);
                        }
                    }


                    if (data.crudOperations === "create") {
                        if (data.table === "leads"){
                            // 3. system_response ë°ì´í„°ë¥¼ URLì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° í˜•íƒœë¡œ ë³€í™˜
                            var queryParams = new URLSearchParams({
                                accountId: systemData.accountId || '',
                                employeeId: systemData.employeeId || '',
                                createdDate: systemData.createdDate || '',
                                targetCloseDate: systemData.targetCloseDate || '',
                                leadSource: systemData.leadSource || '',
                                leadStatus: systemData.leadStatus || '',
                                companyName: systemData.companyName || '',
                                customerRequirements: systemData.customerRequirements || '',
                                customerRepresentitive: systemData.customerRepresentitive || '',
                                // accountManager: systemData["ê³„ì •ë‹´ë‹¹ì"] || '',
                                contact: systemData.c_tel || ''
                            }).toString(); // ì¿¼ë¦¬ ë¬¸ìì—´ ìƒì„±

                            // queryParams ê°’ ë¡œê·¸ ì¶œë ¥
                            console.log("ğŸ” ìƒì„±ëœ queryParams:", queryParams);

                            // 4. formattedResponseì— ì •ë³´ ì¶”ê°€
                            formattedResponse += "<strong>ğŸ“Œ AI CRM ì–´ì‹œìŠ¤í„´íŠ¸ ì¶”ì²œ ë¦¬ë“œ ì •ë³´:</strong><br>";
                            formattedResponse += `<strong>ì‚¬ì›ë²ˆí˜¸</strong>: ${systemData.employeeId || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ìƒì„±ì¼ì</strong>: ${systemData.createdDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë§ˆê°ê¸°í•œ</strong>: ${systemData.targetCloseDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë¦¬ë“œ ì†ŒìŠ¤</strong>: ${systemData.leadSource || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë¦¬ë“œ ìƒíƒœ</strong>: ${systemData.leadStatus || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>íšŒì‚¬ëª…</strong>: ${systemData.companyName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë¦¬ë“œ ë‚´ìš©</strong>: ${systemData.customerRequirements || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì • ë‹´ë‹¹ì</strong>: ${systemData.customerRepresentitive || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì—°ë½ì²˜</strong>: ${systemData.c_tel || 'ì •ë³´ ì—†ìŒ'}<br>`;

                            // íŠ¹ì • ë§í¬ë¥¼ ì¶”ê°€ (ì˜ˆ: ìƒˆë¡œ ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ ë§í¬ ì œê³µ)
                            formattedResponse += `<br><a href="/chatbot/create/leads?${queryParams}" target="_blank">AIì¶”ì²œ ë°ì´í„°ë¡œ ì´ë™</a>`;
                        }

                        if (data.table === "accounts") {
                            // system_response ë°ì´í„°ë¥¼ URLì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° í˜•íƒœë¡œ ë³€í™˜
                            var queryParams = new URLSearchParams({
                                employeeId: systemData.employeeId || '',
                                accountCreatedDate: systemData.accountCreatedDate || '',
                                accountStatus: systemData.accountStatus || '',
                                accountName: systemData.accountName || '',
                                employeeName: systemData.employeeName || '',
                                accountType: systemData.accountType || '',
                                parentAccount: systemData.parentAccount || '',
                                website: systemData.website || '',
                                contact: systemData.contact || '',
                                businessType: systemData.businessType || '',
                                accountManager: systemData.accountManager || '',
                                accountDetail: systemData.accountDetail || '',
                                address: systemData.address || '',
                                accountManagerContact: systemData.accountManagerContact || ''
                            }).toString(); // ì¿¼ë¦¬ ë¬¸ìì—´ ìƒì„±

                            // queryParams ê°’ ë¡œê·¸ ì¶œë ¥
                            console.log("ğŸ” ìƒì„±ëœ queryParams:", queryParams);

                            // 4. formattedResponseì— ì •ë³´ ì¶”ê°€
                            formattedResponse += "<strong>ğŸ“Œ AI CRM ì–´ì‹œìŠ¤í„´íŠ¸ ì¶”ì²œ ê³„ì • ì •ë³´:</strong><br>";
                            formattedResponse += `<strong>ìƒì„± ì¼ì</strong>: ${systemData.accountCreatedDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì • ìƒíƒœ</strong>: ${systemData.accountStatus || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì • ì´ë¦„</strong>: ${systemData.accountName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì•½ ì†Œìœ ì</strong>: ${systemData.employeeName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ìœ í˜•</strong>: ${systemData.accountType || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ìƒìœ„ ê³„ì •</strong>: ${systemData.parentAccount || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì›¹ì‚¬ì´íŠ¸</strong>: ${systemData.website || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ëŒ€í‘œì „í™”</strong>: ${systemData.contact || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì‚¬ì—…ìœ í˜•</strong>: ${systemData.businessType || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì§ì›</strong>: ${systemData.accountManager || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì„¤ëª…</strong>: ${systemData.accountDetail || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë°°ì†¡ì§€</strong>: ${systemData.address || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì§ì› ì „í™”ë²ˆí˜¸</strong>: ${systemData.accountManagerContact || 'ì •ë³´ ì—†ìŒ'}<br>`;

                            // íŠ¹ì • ë§í¬ë¥¼ ì¶”ê°€ (ì˜ˆ: ìƒˆë¡œ ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ ë§í¬ ì œê³µ)
                            formattedResponse += `<br><a href="/chatbot/create/accounts?${queryParams}" target="_blank">AIì¶”ì²œ ë°ì´í„°ë¡œ ì´ë™</a>`;
                        }

                        if (data.table === "opportunities") {
                            // system_response ë°ì´í„°ë¥¼ URLì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° í˜•íƒœë¡œ ë³€í™˜
                            var queryParams = new URLSearchParams({
                                accountId: systemData.accountId || '',
                                employeeId: systemData.employeeId || '',
                                productId: systemData.productId || '',
                                createdDate: systemData.createdDate || '',
                                targetCloseDate: systemData.targetCloseDate || '',
                                opportunityStatus: systemData.opportunityStatus || '',
                                ë¦¬ë“œëª…: systemData["ë¦¬ë“œëª…"] || '',
                                opportunityName: systemData.opportunityName || '',
                                ê³„ì •ëª…: systemData["ê³„ì •ëª…"] || '',
                                ë‹´ë‹¹ìëª…: systemData["ë‹´ë‹¹ìëª…"] || '',
                                successRate: systemData.successRate || '',
                                companyRevenue: systemData.companyRevenue || '',
                                region: systemData.region || '',
                                customerEmployee: systemData.customerEmployee || '',
                                opportunityInquiries: systemData.opportunityInquiries || '',
                                opportunityNotes: systemData.opportunityNotes || '',
                                ì œí’ˆëª…: systemData["ì œí’ˆëª…"] || '',
                                quantity: systemData.quantity || '',
                                expectedRevenue: systemData.expectedRevenue || ''
                            }).toString(); // ì¿¼ë¦¬ ë¬¸ìì—´ ìƒì„±

                            // queryParams ê°’ ë¡œê·¸ ì¶œë ¥
                            console.log("ğŸ” ìƒì„±ëœ queryParams:", queryParams);

                            formattedResponse += "<strong>ğŸ“Œ AI CRM ì–´ì‹œìŠ¤í„´íŠ¸ ì¶”ì²œ ê¸°íšŒ ì •ë³´:</strong><br>";
                            formattedResponse += `<strong>ìƒì„±ì¼ì</strong>: ${systemData.createdDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë§ˆê°ê¸°í•œ</strong>: ${systemData.targetCloseDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒìƒíƒœ</strong>: ${systemData.opportunityStatus || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            // formattedResponse += `<strong>ë¦¬ë“œ ëª…</strong>: ${systemData["ë¦¬ë“œëª…"] || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ëª…</strong>: ${systemData.opportunityName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì • ëª…</strong>: ${systemData.accountName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ë‹´ë‹¹ì</strong>: ${systemData.employeeName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì„±ê³µë¥ </strong>: ${systemData.successRate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>íšŒì‚¬ ë§¤ì¶œ</strong>: ${systemData.companyRevenue || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë°°ì†¡ì§€ì—­</strong>: ${systemData.region || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³ ê°ì‚¬ ë‹´ë‹¹ì</strong>: ${systemData.customerEmployee || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³ ê°ë¬¸ì˜ì‚¬í•­</strong>: ${systemData.opportunityInquiries || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ì„¸ë¶€ë‚´ìš©</strong>: ${systemData.opportunityNotes || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ì œí’ˆ</strong>: ${systemData.productName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ìˆ˜ëŸ‰</strong>: ${systemData.quantity || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ë§¤ì¶œ</strong>: ${systemData.expectedRevenue || 'ì •ë³´ ì—†ìŒ'}<br>`;


                            // íŠ¹ì • ë§í¬ë¥¼ ì¶”ê°€ (ì˜ˆ: ìƒˆë¡œ ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ ë§í¬ ì œê³µ)
                            formattedResponse += `<br><a href="/chatbot/create/opportunities?${queryParams}" target="_blank">AIì¶”ì²œ ë°ì´í„°ë¡œ ì´ë™</a>`;
                        }

                        if (data.table === "contracts") {
                            // system_response ë°ì´í„°ë¥¼ URLì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° í˜•íƒœë¡œ ë³€í™˜
                            var queryParams = new URLSearchParams({
                                accountId: systemData.accountId || '',
                                productId: systemData.productId || '',
                                opportunityId: systemData.opportunityId || '',
                                employeeId: systemData.employeeId || '',
                                startDate: systemData.startDate || '',
                                terminationDate: systemData.terminationDate || '',
                                contractStatus: systemData.contractStatus || '',
                                ê³„ì •ëª…: systemData["ê³„ì •ëª…"] || '',
                                ê¸°íšŒëª…: systemData["ê¸°íšŒëª…"] || '',
                                ì œí’ˆëª…: systemData["ì œí’ˆëª…"] || '',
                                contractAmount: systemData.contractAmount || '',
                                contractSales: systemData.contractSales || '',
                                contractDetail: systemData.contractDetail || '',
                                contractClassification: systemData.contractClassification || '',
                                ë‹´ë‹¹ìëª…: systemData["ë‹´ë‹¹ìëª…"] || ''
                            }).toString(); // ì¿¼ë¦¬ ë¬¸ìì—´ ìƒì„±

                            // queryParams ê°’ ë¡œê·¸ ì¶œë ¥
                            console.log("ğŸ” ìƒì„±ëœ queryParams:", queryParams);

                            formattedResponse += "<strong>ğŸ“Œ AI CRM ì–´ì‹œìŠ¤í„´íŠ¸ ì¶”ì²œ ê³„ì•½ ì •ë³´:</strong><br>";
                            formattedResponse += `<strong>ì‹œì‘ì¼ì</strong>: ${systemData.startDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë§ˆê°ê¸°í•œ</strong>: ${systemData.terminationDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì•½ ìƒíƒœ</strong>: ${systemData.contractStatus || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì •ëª…</strong>: ${systemData.accountName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒëª…</strong>: ${systemData.opportunityName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ì œí’ˆ</strong>: ${systemData.productName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ìˆ˜ëŸ‰</strong>: ${systemData.contractAmount || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì•½ ê°€ê²©</strong>: ${systemData.contractSales || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì•½ ì„¸ë¶€ë‚´ìš©</strong>: ${systemData.contractDetail || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì•½ ë¶„ë¥˜</strong>: ${systemData.contractClassification || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì•½ ì†Œìœ ì</strong>: ${systemData.employeeName || 'ì •ë³´ ì—†ìŒ'}<br>`;


                            // íŠ¹ì • ë§í¬ë¥¼ ì¶”ê°€ (ì˜ˆ: ìƒˆë¡œ ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ ë§í¬ ì œê³µ)
                            formattedResponse += `<br><a href="/chatbot/create/contracts?${queryParams}" target="_blank">AIì¶”ì²œ ë°ì´í„°ë¡œ ì´ë™</a>`;
                        }

                        if (data.table === "orders") {
                            // system_response ë°ì´í„°ë¥¼ URLì˜ ì¿¼ë¦¬ íŒŒë¼ë¯¸í„° í˜•íƒœë¡œ ë³€í™˜
                            var queryParams = new URLSearchParams({
                                contractId: systemData.contract_id || '',
                                productId: systemData.productId || '',
                                orderDate: systemData.orderDate || '',
                                salesDate: systemData.salesDate || '',
                                orderStatus: systemData.orderStatus || '',
                                orderAmount: systemData.orderAmount || '',
                                ì œí’ˆëª…: systemData["ì œí’ˆëª…"] || ''
                            }).toString(); // ì¿¼ë¦¬ ë¬¸ìì—´ ìƒì„±

                            // queryParams ê°’ ë¡œê·¸ ì¶œë ¥
                            console.log("ğŸ” ìƒì„±ëœ queryParams:", queryParams);

                            formattedResponse += "<strong>ğŸ“Œ AI CRM ì–´ì‹œìŠ¤í„´íŠ¸ ì¶”ì²œ ì£¼ë¬¸ ì •ë³´:</strong><br>";
                            formattedResponse += `<strong>ë°œì£¼ì¼ì</strong>: ${systemData.orderDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë§¤ì¶œì¼ì</strong>: ${systemData.salesDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì£¼ë¬¸ìƒíƒœ</strong>: ${systemData.orderStatus || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ìˆ˜ëŸ‰</strong>: ${systemData.orderAmount || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì œí’ˆ</strong>: ${systemData.productName || 'ì •ë³´ ì—†ìŒ'}<br>`;

                            // íŠ¹ì • ë§í¬ë¥¼ ì¶”ê°€ (ì˜ˆ: ìƒˆë¡œ ìƒì„±ëœ ë¦¬ì†ŒìŠ¤ ë§í¬ ì œê³µ)
                            formattedResponse += `<br><a href="/chatbot/create/orders?${queryParams}" target="_blank">AIì¶”ì²œ ë°ì´í„°ë¡œ ì´ë™</a>`;
                        }

                    }


                    if (["select", "update", "delete"].includes(data.crudOperations)) {

                        if (data.table === "leads") {
                            formattedResponse += "<strong>ğŸ“Œ AI CRM ì–´ì‹œìŠ¤í„´íŠ¸ ê²€ìƒ‰ ë¦¬ë“œ ì •ë³´:</strong><br>";
                            formattedResponse += `<strong>ì‚¬ì›ë²ˆí˜¸</strong>: ${systemData.employeeId || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ìƒì„±ì¼ì</strong>: ${systemData.createdDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë§ˆê°ê¸°í•œ</strong>: ${systemData.targetCloseDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë¦¬ë“œ ì†ŒìŠ¤</strong>: ${systemData.leadSource || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë¦¬ë“œ ìƒíƒœ</strong>: ${systemData.leadStatus || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>íšŒì‚¬ëª…</strong>: ${systemData.companyName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë¦¬ë“œ ë‚´ìš©</strong>: ${systemData.customerRequirements || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì • ë‹´ë‹¹ì</strong>: ${systemData.employeeName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì—°ë½ì²˜</strong>: ${systemData.c_tel || 'ì •ë³´ ì—†ìŒ'}<br>`;

                            var dataId = systemData?.leadId;
                            console.log(`ğŸ” ì´ë™í•  ë°ì´í„° ID: ${dataId}`);
                            formattedResponse += `<br><a href="/leads/detail/${dataId}" target="_blank">ë¦¬ë“œë¡œ ì´ë™</a>`;
                        }

                        if (data.table === "accounts") {
                            formattedResponse += "<strong>ğŸ“Œ AI CRM ì–´ì‹œìŠ¤í„´íŠ¸ ê²€ìƒ‰ ê³„ì • ì •ë³´:</strong><br>";
                            formattedResponse += `<strong>ìƒì„± ì¼ì</strong>: ${systemData.accountCreatedDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì • ìƒíƒœ</strong>: ${systemData.accountStatus || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì • ì´ë¦„</strong>: ${systemData.accountName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì•½ ì†Œìœ ì</strong>: ${systemData.employeeName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ìœ í˜•</strong>: ${systemData.accountType || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ìƒìœ„ ê³„ì •</strong>: ${systemData.parentAccount || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì›¹ì‚¬ì´íŠ¸</strong>: ${systemData.website || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ëŒ€í‘œì „í™”</strong>: ${systemData.contact || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì‚¬ì—…ìœ í˜•</strong>: ${systemData.businessType || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì§ì›</strong>: ${systemData.accountManager || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì„¤ëª…</strong>: ${systemData.accountDetail || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë°°ì†¡ì§€</strong>: ${systemData.address || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì§ì› ì „í™”ë²ˆí˜¸</strong>: ${systemData.accountManagerContact || 'ì •ë³´ ì—†ìŒ'}<br>`;

                            var dataId = systemData?.accountId;
                            console.log(`ğŸ” ì´ë™í•  ë°ì´í„° ID: ${dataId}`);
                            formattedResponse += `<br><a href="/account/detail/${dataId}" target="_blank">ê³„ì •ìœ¼ë¡œ ì´ë™</a>`;
                        }

                        if (data.table === "opportunities") {

                            formattedResponse += "<strong>ğŸ“Œ AI CRM ì–´ì‹œìŠ¤í„´íŠ¸ ê²€ìƒ‰ ê¸°íšŒ ì •ë³´:</strong><br>";
                            formattedResponse += `<strong>ìƒì„±ì¼ì</strong>: ${systemData.createdDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë§ˆê°ê¸°í•œ</strong>: ${systemData.targetCloseDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒìƒíƒœ</strong>: ${systemData.opportunityStatus || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ëª…</strong>: ${systemData.opportunityName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì • ëª…</strong>: ${systemData.accountName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ë‹´ë‹¹ì</strong>: ${systemData.employeeName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì„±ê³µë¥ </strong>: ${systemData.successRate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>íšŒì‚¬ ë§¤ì¶œ</strong>: ${systemData.companyRevenue || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë°°ì†¡ì§€ì—­</strong>: ${systemData.region || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³ ê°ì‚¬ ë‹´ë‹¹ì</strong>: ${systemData.customerEmployee || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³ ê°ë¬¸ì˜ì‚¬í•­</strong>: ${systemData.opportunityInquiries || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ì„¸ë¶€ë‚´ìš©</strong>: ${systemData.opportunityNotes || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ì œí’ˆ</strong>: ${systemData.productName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ìˆ˜ëŸ‰</strong>: ${systemData.quantity || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ë§¤ì¶œ</strong>: ${systemData.expectedRevenue || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            var dataId = systemData?.opportunityId;
                            console.log(`ğŸ” ì´ë™í•  ë°ì´í„° ID: ${dataId}`);
                            formattedResponse += `<br><a href="/opportunities/detail/${dataId}" target="_blank">ê¸°íšŒë¡œ ì´ë™</a>`;
                        }

                        if (data.table === "contracts") {
                            formattedResponse += "<strong>ğŸ“Œ AI CRM ì–´ì‹œìŠ¤í„´íŠ¸ ê²€ìƒ‰ ê³„ì•½ ì •ë³´:</strong><br>";
                            formattedResponse += `<strong>ì‹œì‘ì¼ì</strong>: ${systemData.startDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë§ˆê°ê¸°í•œ</strong>: ${systemData.terminationDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì•½ ìƒíƒœ</strong>: ${systemData.contractStatus || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì •ëª…</strong>: ${systemData.accountName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒëª…</strong>: ${systemData.opportunityName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ì œí’ˆ</strong>: ${systemData.productName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê¸°íšŒ ìˆ˜ëŸ‰</strong>: ${systemData.contractAmount || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì•½ ê°€ê²©</strong>: ${systemData.contractSales || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì•½ ì„¸ë¶€ë‚´ìš©</strong>: ${systemData.contractDetail || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì•½ ë¶„ë¥˜</strong>: ${systemData.contractClassification || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ê³„ì•½ ì†Œìœ ì</strong>: ${systemData.employeeName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            var dataId = systemData?.contractId;
                            console.log(`ğŸ” ì´ë™í•  ë°ì´í„° ID: ${dataId}`);
                            formattedResponse += `<br><a href="/contracts/detail/${dataId}" target="_blank">ê³„ì•½ìœ¼ë¡œ ì´ë™</a>`;
                        }

                        if (data.table === "orders") {
                            formattedResponse += "<strong>ğŸ“Œ AI CRM ì–´ì‹œìŠ¤í„´íŠ¸ ê²€ìƒ‰ ì£¼ë¬¸ ì •ë³´:</strong><br>";
                            formattedResponse += `<strong>ë°œì£¼ì¼ì</strong>: ${systemData.orderDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ë§¤ì¶œì¼ì</strong>: ${systemData.salesDate || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì£¼ë¬¸ìƒíƒœ</strong>: ${systemData.orderStatus || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ìˆ˜ëŸ‰</strong>: ${systemData.orderAmount || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            formattedResponse += `<strong>ì œí’ˆ</strong>: ${systemData.productName || 'ì •ë³´ ì—†ìŒ'}<br>`;
                            var dataId = systemData?.orderId;
                            console.log(`ğŸ” ì´ë™í•  ë°ì´í„° ID: ${dataId}`);
                            formattedResponse += `<br><a href="/orders/detail/${dataId}" target="_blank">ì£¼ë¬¸ìœ¼ë¡œ ì´ë™</a>`;
                        }
                    }




                    var botMessage = "<div class='chat-container'><div class='bot-info message-info'>sAIes CRM</div><div class='bot-message'>" + formattedResponse + "<br><span class='message-info'>" + currentTime + "</span></div></div>";
                    document.getElementById('chatbotMessages').innerHTML += botMessage;




                    // ëª¨ë‹¬ ì°½ ë‚´ì˜ ìŠ¤í¬ë¡¤ ìµœí•˜ë‹¨ìœ¼ë¡œ ë‚´ë¦¬ê¸°
                    setTimeout(function() {
                        document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;
                    }, 100); // ë”œë ˆì´ ì¡°ì • ê°€ëŠ¥

                    // TTS API í˜¸ì¶œ ë¶€ë¶„
                    // ì¤„ë°”ê¿ˆ ë¬¸ìë¥¼ ì œê±°í•˜ê³  JSON í˜•ì‹ì˜ í…ìŠ¤íŠ¸ë¥¼ ì§€ì›Œì„œ í¬ë§·íŒ…
                    var normalizedResponse = formattedResponse.replace(/\\n/g, ' ').replace(/\n/g, ' ').replace(/{[^{}]*}/g, '').replace(/<br>/g, '');

                    //fetch('http://127.0.0.1:8000/tts', {
                    fetch('https://saiescrm.tts.jyds.synology.me/tts', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ request: normalizedResponse, user_id: user_id })
                    })
                    .then(response => {
                        if (response.ok) {
                            return response.blob();
                        } else {
                            throw new Error('TTS API í˜¸ì¶œ ì‹¤íŒ¨');
                        }
                    })
                    .then(blob => {
                        var audioUrl = URL.createObjectURL(blob);
                        var audio = new Audio(audioUrl);
                        audio.play();
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        var botMessage = "<div class='chat-container'><div class='bot-info message-info'>sAIes CRM</div><div class='bot-message'>TTS API í˜¸ì¶œ ì˜¤ë¥˜: " + error.message + "<br><span class='message-info'>" + currentTime + "</span></div></div>";
                        document.getElementById('chatbotMessages').innerHTML += botMessage;
                        setTimeout(function() {
                            document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;
                        }, 100); // ë”œë ˆì´ ì¡°ì • ê°€ëŠ¥
                    });
                })
                .catch(error => {
                    console.error('Error:', error);
                    var botMessage = "<div class='chat-container'><div class='bot-info message-info'>sAIes CRM</div><div class='bot-message'>API í˜¸ì¶œ ì˜¤ë¥˜: " + error.message + "<br><span class='message-info'>" + currentTime + "</span></div></div>";
                    document.getElementById('chatbotMessages').innerHTML += botMessage;
                    setTimeout(function() {
                        document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;
                    }, 100); // ë”œë ˆì´ ì¡°ì • ê°€ëŠ¥
                });
            }


            document.getElementById('chatbotInput').onkeydown = function(event) {
                if (event.key === 'Enter') {
                    sendChatbotMessage();
                    setTimeout(function() {
                        document.getElementById('chatbotMessages').scrollTop = document.getElementById('chatbotMessages').scrollHeight;
                    }, 100); // Adjust the delay as needed
                }
            };

            // ì´ˆê¸° ë©”ì‹œì§€ë¥¼ ì„¤ì •í•˜ëŠ” í•¨ìˆ˜
            var initializeChat = function() {
                var initialMessage = "<div class='chat-container'><div class='bot-info message-info'>sAIes CRM</div><div class='bot-message'>ì•ˆë…•í•˜ì„¸ìš”. CRM ì–´ì‹œìŠ¤ë˜íŠ¸ ì…ë‹ˆë‹¤. ë¬´ì—‡ì„ ë„ì™€ë“œë¦´ê¹Œìš”?<br><span class='message-info'>" + new Date().toLocaleTimeString() + "</span></div></div>";
                document.getElementById('chatbotMessages').innerHTML = initialMessage;
            };







        });


    </script>